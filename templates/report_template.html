<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç±³å›½ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¬ãƒãƒ¼ãƒˆ - {{ report_date }}</title>
    <link rel="stylesheet" href="{{ css_path }}"> {# CSSãƒ‘ã‚¹ã‚’Jinja2å¤‰æ•°ã§å—ã‘å–ã‚‹ #}
</head>
<body>
    <!-- Report generated at: {{ generation_time }} -->
    <div class="container">
        <header>
            <h1>ç±³å›½ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¬ãƒãƒ¼ãƒˆ</h1>
            <p class="report-date">{{ report_date }}</p>
        </header>

        <section class="market-summary">
            <div class="update-info">
                <div class="last-updated">
                    <span class="pulse-dot"></span>
                    <span>æœ€çµ‚æ›´æ–°: <span class="update-time">{{ report_date }}</span></span>
                </div>
                <div class="currency-toggle">
                    <div class="currency-option active" data-currency="original">ã‚ªãƒªã‚¸ãƒŠãƒ«</div>
                    <div class="currency-option" data-currency="jpy">å††æ›ç®—</div>
                </div>
                <div class="freshness-indicator freshness-fresh">
                    <div class="pulse-dot"></div>
                    <span>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </span>
                </div>
            </div>

            <h2>ä¸»è¦æŒ‡æ¨™</h2>
            
            <div class="market-cards-container">
                <!-- æ ªå¼æŒ‡æ•° -->
                <div class="market-category">
                    <h3>ğŸ›ï¸ æ ªå¼æŒ‡æ•°</h3>
                    <div class="market-cards">
                        {% for name, data in market_data.items() %}
                        {% if name in ['S&P500', 'NASDAQ100', 'ãƒ€ã‚¦30', 'SOX', 'æ—¥çµŒ225'] %}
                        <div class="market-card-wrapper">
                            <div class="market-card {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% else %}neutral{% endif %}{% endif %} tooltip" 
                                 data-indicator="{{ name }}" 
                                 data-current="{{ data.current }}"
                                 data-change="{{ data.change }}"
                                 data-change-percent="{{ data.change_percent }}"
                                 data-rsi="{{ data.rsi if data.rsi is defined else 'N/A' }}"
                                 data-rsi-color="{{ data.rsi_color if data.rsi_color is defined else '#6c757d' }}"
                                 data-ma-divergence="{{ data.ma_divergence if data.ma_divergence is defined else 'N/A' }}"
                                 data-ma-divergence-color="{{ data.ma_divergence_color if data.ma_divergence_color is defined else '#6c757d' }}"
                                 data-volume-analysis="{{ data.volume_analysis if data.volume_analysis is defined else 'N/A' }}"
                                 data-volume-analysis-color="{{ data.volume_analysis_color if data.volume_analysis_color is defined else '#6c757d' }}"
                                 data-chart-intraday="charts/{{ name }}_intraday.html"
                                 data-chart-longterm="charts/{{ name }}_longterm.html"
                                 data-chart-intraday-img="{% if static_chart_paths and name in static_chart_paths and 'intraday' in static_chart_paths[name] %}{{ static_chart_paths[name]['intraday'] }}{% else %}charts/{{ name.replace(' ', '_') }}_intraday_static.png{% endif %}"
                                 data-chart-longterm-img="{% if static_chart_paths and name in static_chart_paths and 'longterm' in static_chart_paths[name] %}{{ static_chart_paths[name]['longterm'] }}{% else %}charts/{{ name.replace(' ', '_') }}_longterm_static.png{% endif %}">
                                <div class="card-header">
                                    <div class="indicator-name">{{ name }}</div>
                                    <div class="indicator-symbol">{{ name[:3] | upper }}</div>
                                </div>
                                <div class="card-value" data-original="{{ data.current }}">{{ data.current }}</div>
                                <div class="yen-converted" style="display: none;"></div>
                                <div class="card-change {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                    <span class="trend-arrow {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}trend-up{% elif data.change_percent | replace('%', '') | float < 0 %}trend-down{% else %}trend-neutral{% endif %}{% endif %}"></span>
                                    <span class="change-value">
                                        {% if data.change is defined and data.change != 'N/A' %}
                                            {{ data.change }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        {% if data.change_bp is defined and data.change_bp != 'N/A' %}
                                            ({{ data.change_bp }}bp)
                                        {% endif %}
                                    </span>
                                    <span class="change-percent">
                                        {% if data.change_percent is defined and data.change_percent != 'N/A' %}
                                            {{ data.change_percent }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="tooltiptext">
                                    {{ name }}ã®è©³ç´°æƒ…å ±ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º
                                </div>
                                <div class="hover-details">
                                    <h4>{{ name }} è©³ç´°</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">ç¾åœ¨å€¤:</span>
                                        <span class="detail-value">{{ data.current }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å‰æ—¥æ¯”:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change if data.change != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å¤‰åŒ–ç‡:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change_percent if data.change_percent != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-chart"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- é‡‘åˆ© -->
                <div class="market-category">
                    <h3>ğŸ“ˆ é‡‘åˆ©</h3>
                    <div class="market-cards">
                        {% for name, data in market_data.items() %}
                        {% if name in ['ç±³å›½2å¹´é‡‘åˆ©', 'ç±³å›½10å¹´é‡‘åˆ©'] %}
                        <div class="market-card-wrapper">
                            <div class="market-card {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% else %}neutral{% endif %}{% endif %} tooltip" 
                                 data-indicator="{{ name }}" 
                                 data-current="{{ data.current }}"
                                 data-change="{{ data.change }}"
                                 data-change-percent="{{ data.change_percent }}"
                                 data-rsi="{{ data.rsi if data.rsi is defined else 'N/A' }}"
                                 data-rsi-color="{{ data.rsi_color if data.rsi_color is defined else '#6c757d' }}"
                                 data-ma-divergence="{{ data.ma_divergence if data.ma_divergence is defined else 'N/A' }}"
                                 data-ma-divergence-color="{{ data.ma_divergence_color if data.ma_divergence_color is defined else '#6c757d' }}"
                                 data-volume-analysis="{{ data.volume_analysis if data.volume_analysis is defined else 'N/A' }}"
                                 data-volume-analysis-color="{{ data.volume_analysis_color if data.volume_analysis_color is defined else '#6c757d' }}"
                                 data-chart-intraday="charts/{{ name }}_intraday.html"
                                 data-chart-longterm="charts/{{ name }}_longterm.html"
                                 data-chart-intraday-img="{% if static_chart_paths and name in static_chart_paths and 'intraday' in static_chart_paths[name] %}{{ static_chart_paths[name]['intraday'] }}{% else %}charts/{{ name.replace(' ', '_') }}_intraday_static.png{% endif %}"
                                 data-chart-longterm-img="{% if static_chart_paths and name in static_chart_paths and 'longterm' in static_chart_paths[name] %}{{ static_chart_paths[name]['longterm'] }}{% else %}charts/{{ name.replace(' ', '_') }}_longterm_static.png{% endif %}">
                                <div class="card-header">
                                    <div class="indicator-name">{{ name }}</div>
                                    <div class="indicator-symbol">{{ name.replace('ç±³å›½', '').replace('å¹´é‡‘åˆ©', 'Y') }}</div>
                                </div>
                                <div class="card-value" data-original="{{ data.current }}">{{ data.current }}%</div>
                                <div class="card-change {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                    <span class="trend-arrow {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}trend-up{% elif data.change_percent | replace('%', '') | float < 0 %}trend-down{% else %}trend-neutral{% endif %}{% endif %}"></span>
                                    <span class="change-value">
                                        {% if data.change is defined and data.change != 'N/A' %}
                                            {{ data.change }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        {% if data.change_bp is defined and data.change_bp != 'N/A' %}
                                            ({{ data.change_bp }}bp)
                                        {% endif %}
                                    </span>
                                    <span class="change-percent">
                                        {% if data.change_percent is defined and data.change_percent != 'N/A' %}
                                            {{ data.change_percent }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="tooltiptext">
                                    {{ name }}ã®è©³ç´°æƒ…å ±ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º
                                </div>
                                <div class="hover-details">
                                    <h4>{{ name }} è©³ç´°</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">ç¾åœ¨å€¤:</span>
                                        <span class="detail-value">{{ data.current }}%</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å‰æ—¥æ¯”:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change if data.change != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å¤‰åŒ–ç‡:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change_percent if data.change_percent != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-chart"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- ç‚ºæ›¿ -->
                <div class="market-category">
                    <h3>ğŸ’± ç‚ºæ›¿</h3>
                    <div class="market-cards">
                        {% for name, data in market_data.items() %}
                        {% if name in ['DXYãƒ‰ãƒ«æŒ‡æ•°', 'ãƒ‰ãƒ«å††', 'ãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ«'] %}
                        <div class="market-card-wrapper">
                            <div class="market-card {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% else %}neutral{% endif %}{% endif %} tooltip" 
                                 data-indicator="{{ name }}" 
                                 data-current="{{ data.current }}"
                                 data-change="{{ data.change }}"
                                 data-change-percent="{{ data.change_percent }}"
                                 data-rsi="{{ data.rsi if data.rsi is defined else 'N/A' }}"
                                 data-rsi-color="{{ data.rsi_color if data.rsi_color is defined else '#6c757d' }}"
                                 data-ma-divergence="{{ data.ma_divergence if data.ma_divergence is defined else 'N/A' }}"
                                 data-ma-divergence-color="{{ data.ma_divergence_color if data.ma_divergence_color is defined else '#6c757d' }}"
                                 data-volume-analysis="{{ data.volume_analysis if data.volume_analysis is defined else 'N/A' }}"
                                 data-volume-analysis-color="{{ data.volume_analysis_color if data.volume_analysis_color is defined else '#6c757d' }}"
                                 data-chart-intraday="charts/{{ name }}_intraday.html"
                                 data-chart-longterm="charts/{{ name }}_longterm.html"
                                 data-chart-intraday-img="{% if static_chart_paths and name in static_chart_paths and 'intraday' in static_chart_paths[name] %}{{ static_chart_paths[name]['intraday'] }}{% else %}charts/{{ name.replace(' ', '_') }}_intraday_static.png{% endif %}"
                                 data-chart-longterm-img="{% if static_chart_paths and name in static_chart_paths and 'longterm' in static_chart_paths[name] %}{{ static_chart_paths[name]['longterm'] }}{% else %}charts/{{ name.replace(' ', '_') }}_longterm_static.png{% endif %}">
                                <div class="card-header">
                                    <div class="indicator-name">{{ name }}</div>
                                    <div class="indicator-symbol">{{ name.replace('DXY', '').replace('ãƒ‰ãƒ«æŒ‡æ•°', 'DXY').replace('ãƒ‰ãƒ«å††', 'USDJPY').replace('ãƒ¦ãƒ¼ãƒ­ãƒ‰ãƒ«', 'EURUSD') }}</div>
                                </div>
                                <div class="card-value" data-original="{{ data.current }}">{{ data.current }}</div>
                                <div class="card-change {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                    <span class="trend-arrow {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}trend-up{% elif data.change_percent | replace('%', '') | float < 0 %}trend-down{% else %}trend-neutral{% endif %}{% endif %}"></span>
                                    <span class="change-value">
                                        {% if data.change is defined and data.change != 'N/A' %}
                                            {{ data.change }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                    <span class="change-percent">
                                        {% if data.change_percent is defined and data.change_percent != 'N/A' %}
                                            {{ data.change_percent }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="tooltiptext">
                                    {{ name }}ã®è©³ç´°æƒ…å ±ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º
                                </div>
                                <div class="hover-details">
                                    <h4>{{ name }} è©³ç´°</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">ç¾åœ¨å€¤:</span>
                                        <span class="detail-value">{{ data.current }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å‰æ—¥æ¯”:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change if data.change != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å¤‰åŒ–ç‡:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change_percent if data.change_percent != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-chart"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- ã‚³ãƒ¢ãƒ‡ã‚£ãƒ†ã‚£ -->
                <div class="market-category">
                    <h3>ğŸ—ï¸ ã‚³ãƒ¢ãƒ‡ã‚£ãƒ†ã‚£</h3>
                    <div class="market-cards">
                        {% for name, data in market_data.items() %}
                        {% if name in ['ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³', 'ã‚´ãƒ¼ãƒ«ãƒ‰', 'åŸæ²¹'] %}
                        <div class="market-card-wrapper">
                            <div class="market-card {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% else %}neutral{% endif %}{% endif %} tooltip" 
                                 data-indicator="{{ name }}" 
                                 data-current="{{ data.current }}"
                                 data-change="{{ data.change }}"
                                 data-change-percent="{{ data.change_percent }}">
                                <div class="card-header">
                                    <div class="indicator-name">{{ name }}</div>
                                    <div class="indicator-symbol">{{ name.replace('ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³', 'BTC').replace('ã‚´ãƒ¼ãƒ«ãƒ‰', 'GOLD').replace('åŸæ²¹', 'OIL') }}</div>
                                </div>
                                <div class="card-value" data-original="{{ data.current }}">{{ data.current }}</div>
                                <div class="yen-converted" style="display: none;"></div>
                                <div class="card-change {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                    <span class="trend-arrow {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}trend-up{% elif data.change_percent | replace('%', '') | float < 0 %}trend-down{% else %}trend-neutral{% endif %}{% endif %}"></span>
                                    <span class="change-value">
                                        {% if data.change is defined and data.change != 'N/A' %}
                                            {{ data.change }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                    <span class="change-percent">
                                        {% if data.change_percent is defined and data.change_percent != 'N/A' %}
                                            {{ data.change_percent }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="tooltiptext">
                                    {{ name }}ã®è©³ç´°æƒ…å ±ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º
                                </div>
                                <div class="hover-details">
                                    <h4>{{ name }} è©³ç´°</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">ç¾åœ¨å€¤:</span>
                                        <span class="detail-value">{{ data.current }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å‰æ—¥æ¯”:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change if data.change != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å¤‰åŒ–ç‡:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change_percent if data.change_percent != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-chart"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- VIXï¼ˆææ€–æŒ‡æ•°ï¼‰ -->
                <div class="market-category">
                    <h3>âš¡ ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£</h3>
                    <div class="market-cards">
                        {% for name, data in market_data.items() %}
                        {% if name == 'VIX' %}
                        <div class="market-card-wrapper">
                            <div class="market-card {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% else %}neutral{% endif %}{% endif %} tooltip" 
                                 data-indicator="{{ name }}" 
                                 data-current="{{ data.current }}"
                                 data-change="{{ data.change }}"
                                 data-change-percent="{{ data.change_percent }}"
                                 data-rsi="{{ data.rsi if data.rsi is defined else 'N/A' }}"
                                 data-rsi-color="{{ data.rsi_color if data.rsi_color is defined else '#6c757d' }}"
                                 data-ma-divergence="{{ data.ma_divergence if data.ma_divergence is defined else 'N/A' }}"
                                 data-ma-divergence-color="{{ data.ma_divergence_color if data.ma_divergence_color is defined else '#6c757d' }}"
                                 data-volume-analysis="{{ data.volume_analysis if data.volume_analysis is defined else 'N/A' }}"
                                 data-volume-analysis-color="{{ data.volume_analysis_color if data.volume_analysis_color is defined else '#6c757d' }}"
                                 data-chart-intraday="charts/{{ name }}_intraday.html"
                                 data-chart-longterm="charts/{{ name }}_longterm.html"
                                 data-chart-intraday-img="{% if static_chart_paths and name in static_chart_paths and 'intraday' in static_chart_paths[name] %}{{ static_chart_paths[name]['intraday'] }}{% else %}charts/{{ name.replace(' ', '_') }}_intraday_static.png{% endif %}"
                                 data-chart-longterm-img="{% if static_chart_paths and name in static_chart_paths and 'longterm' in static_chart_paths[name] %}{{ static_chart_paths[name]['longterm'] }}{% else %}charts/{{ name.replace(' ', '_') }}_longterm_static.png{% endif %}">
                                <div class="card-header">
                                    <div class="indicator-name">{{ name }} (ææ€–æŒ‡æ•°)</div>
                                    <div class="indicator-symbol">VIX</div>
                                </div>
                                <div class="card-value" data-original="{{ data.current }}">{{ data.current }}</div>
                                <div class="card-change {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                    <span class="trend-arrow {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}trend-up{% elif data.change_percent | replace('%', '') | float < 0 %}trend-down{% else %}trend-neutral{% endif %}{% endif %}"></span>
                                    <span class="change-value">
                                        {% if data.change is defined and data.change != 'N/A' %}
                                            {{ data.change }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                    <span class="change-percent">
                                        {% if data.change_percent is defined and data.change_percent != 'N/A' %}
                                            {{ data.change_percent }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="tooltiptext">
                                    å¸‚å ´ã®ææ€–ãƒ»ä¸å®‰å¿ƒç†ã‚’ç¤ºã™æŒ‡æ•°
                                </div>
                                <div class="hover-details">
                                    <h4>{{ name }} è©³ç´°</h4>
                                    <div class="detail-row">
                                        <span class="detail-label">ç¾åœ¨å€¤:</span>
                                        <span class="detail-value">{{ data.current }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å‰æ—¥æ¯”:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change if data.change != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">å¤‰åŒ–ç‡:</span>
                                        <span class="detail-value {% if data.change_percent and data.change_percent != 'N/A' %}{% if data.change_percent | replace('%', '') | float > 0 %}positive{% elif data.change_percent | replace('%', '') | float < 0 %}negative{% endif %}{% endif %}">
                                            {{ data.change_percent if data.change_percent != 'N/A' else 'N/A' }}
                                        </span>
                                    </div>
                                    <div class="detail-chart"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Market Modal for detailed view -->
            <div class="market-modal" id="marketModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title" id="modalTitle">å¸‚å ´æŒ‡æ¨™è©³ç´°</h2>
                        <button class="modal-close" id="modalClose">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-section">
                            <h3>åŸºæœ¬æƒ…å ±</h3>
                            <div id="modalBasicInfo"></div>
                        </div>
                        <div class="modal-section">
                            <h3>ãƒãƒ£ãƒ¼ãƒˆ</h3>
                            <div class="modal-chart">
                                <div class="chart-tabs" style="display: none;">
                                    <button class="chart-tab-btn active" data-chart="intraday">ã‚¤ãƒ³ãƒˆãƒ©ãƒ‡ã‚¤</button>
                                </div>
                                <div id="modalChartContainer">
                                    <img id="modalChartFrame" src="" alt="Chart" style="width: 100%; height: auto; display: none;">
                                    <div class="chart-loading" id="chartLoadingIndicator">
                                        <div>ğŸ“Š ãƒãƒ£ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</div>
                                        <small style="margin-top: 10px; opacity: 0.8;">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="economic-indicators">
            <h2>çµŒæ¸ˆæŒ‡æ¨™</h2>
            <h3>å‰æ—¥ç™ºè¡¨ã•ã‚ŒãŸçµŒæ¸ˆæŒ‡æ¨™</h3>
            {% if economic_indicators.yesterday %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ™‚åˆ»</th>
                            <th>ã‚¤ãƒ™ãƒ³ãƒˆ</th>
                            <th>å‰å›å€¤</th>
                            <th>ç™ºè¡¨å€¤</th>
                            <th>äºˆæƒ³å€¤</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in economic_indicators.yesterday %}
                        <tr>
                            <td>{{ item.time }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.previous if item.previous is not none else 'N/A' }}</td>
                            <td>{{ item.actual if item.actual is not none else 'N/A' }}</td>
                            <td>{{ item.forecast if item.forecast is not none else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>å‰æ—¥ç™ºè¡¨ã•ã‚ŒãŸçµŒæ¸ˆæŒ‡æ¨™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}

            <h3>æœ¬æ—¥ç™ºè¡¨äºˆå®šã®çµŒæ¸ˆæŒ‡æ¨™</h3>
            {% if economic_indicators.today_scheduled %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>æ™‚åˆ»</th>
                            <th>ã‚¤ãƒ™ãƒ³ãƒˆ</th>
                            <th>å‰å›å€¤</th>
                            <th>äºˆæƒ³å€¤</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in economic_indicators.today_scheduled %}
                        <tr>
                            <td>{{ item.time }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.previous if item.previous is not none else 'N/A' }}</td>
                            <td>{{ item.forecast if item.forecast is not none else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>æœ¬æ—¥ç™ºè¡¨äºˆå®šã®çµŒæ¸ˆæŒ‡æ¨™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </section>

        <section class="sector-performance">
            <h2>ç±³å›½ã‚»ã‚¯ã‚¿ãƒ¼ETFå¤‰åŒ–ç‡</h2>
            {% if sector_chart_path %}
            <div class="sector-chart-container">
                {% if 'html' in sector_chart_path.lower() %}
                    <iframe src="{{ sector_chart_path }}" width="100%" height="600" frameborder="0"></iframe>
                {% else %}
                    <img src="{{ sector_chart_path }}" alt="Sector Performance Chart">
                {% endif %}
            </div>
            {% else %}
            <p>ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥ETFã®ãƒãƒ£ãƒ¼ãƒˆã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </section>

        <section class="charts">
            <h2>ãƒãƒ£ãƒ¼ãƒˆ</h2>
            
            <!-- Chart Customization Controls -->
            <div class="chart-controls">
                <h3>ãƒãƒ£ãƒ¼ãƒˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
                <div class="chart-options">
                    <div class="option-group">
                        <label for="maType">ç§»å‹•å¹³å‡ã‚¿ã‚¤ãƒ—:</label>
                        <select id="maType">
                            <option value="SMA">å˜ç´”ç§»å‹•å¹³å‡ (SMA)</option>
                            <option value="EMA">æŒ‡æ•°ç§»å‹•å¹³å‡ (EMA)</option>
                            <option value="WMA">åŠ é‡ç§»å‹•å¹³å‡ (WMA)</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label>è¡¨ç¤ºã™ã‚‹ç§»å‹•å¹³å‡:</label>
                        <div class="ma-checkboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" id="maShort" value="short" checked>
                                <span>25æ—¥ç·š (çŸ­æœŸ)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="maMedium" value="medium">
                                <span>50æ—¥ç·š (ä¸­æœŸ)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="maLong" value="long" checked>
                                <span>75æ—¥ç·š (é•·æœŸ)</span>
                            </label>
                        </div>
                    </div>
                    <div class="option-group">
                        <button id="updateCharts" type="button">ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°</button>
                        <button id="resetCharts" type="button">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                    </div>
                </div>
            </div>
            
            {% for chart_type, charts in grouped_charts.items() %}
            <div class="chart-section">
                <h3>{{ chart_type }}ãƒãƒ£ãƒ¼ãƒˆ</h3>
                <div class="tabs">
                    <div class="tab-buttons">
                        {% for chart in charts %}
                        <button class="tab-button {% if loop.first %}active{% endif %}" data-tab-target="{{ chart.id }}">{{ chart.name }}</button>
                        {% endfor %}
                    </div>
                    <div class="tab-contents">
                        {% for chart in charts %}
                        <div id="{{ chart.id }}" class="tab-content {% if not loop.first %}hidden{% endif %}" {% if not chart.interactive %}data-src="{{ chart.path_with_buster }}"{% endif %}> 
                             {% if chart.interactive %}
                                 <iframe src="{{ chart.path_with_buster }}" width="100%" height="650" frameborder="0"></iframe>
                             {% else %}
                                 <img src="" alt="{{ chart.name }} Chart"> 
                             {% endif %}
                         </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </section>

        <section class="market-commentary">
            <h2>ãƒãƒ¼ã‚±ãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆ</h2>
            <div class="commentary-content">
                {{ commentary | safe }}
            </div>
        </section>

        <section class="news">
            <h2>ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="countryFilter">å›½ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                    <select id="countryFilter">
                        <option value="ALL">ã™ã¹ã¦</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="keywordFilter">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢:</label>
                    <input type="text" id="keywordFilter" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢...">
                </div>
                <div class="filter-group">
                    <button id="clearFilters" type="button">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
            {% if news_articles %}
            <div class="table-container">
                <table id="newsTable">
                    <thead>
                        <tr>
                            <th data-type="date" class="sortable asc">æ™‚åˆ»<span class="sort-arrow"></span></th>
                            <th data-type="string" class="sortable">å›½<span class="sort-arrow"></span></th>
                            <th data-type="string" class="sortable">ã‚¿ã‚¤ãƒˆãƒ«<span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for article in news_articles %}
                        <tr data-title="{{ article.title|lower }}" data-country="{{ article.country }}">
                            <td>{{ article.published_jst.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ article.country }}</td>
                            <td><a href="{{ article.url }}" target="_blank">{{ article.title }}</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div id="newsCount" class="news-count">
                è¡¨ç¤ºä»¶æ•°: <span id="visibleCount">{{ news_articles|length }}</span> / <span id="totalCount">{{ news_articles|length }}</span>
            </div>
            {% else %}
            <p>å–å¾—ã§ãã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            {% endif %}
        </section>

        <footer>
            <p>&copy; {{ report_date.split('å¹´')[0] }} ç±³å›½ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¬ãƒãƒ¼ãƒˆ</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Exchange rate for JPY conversion (this would typically come from an API)
            const USDJPY_RATE = 146.29; // This should be dynamic in a real implementation
            
            /* ---------- Currency Conversion Toggle ---------- */
            const currencyOptions = document.querySelectorAll('.currency-option');
            const cardValues = document.querySelectorAll('.card-value');
            const yenConverted = document.querySelectorAll('.yen-converted');
            
            currencyOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    currencyOptions.forEach(opt => opt.classList.remove('active'));
                    // Add active class to clicked option
                    this.classList.add('active');
                    
                    const currency = this.dataset.currency;
                    
                    cardValues.forEach((cardValue, index) => {
                        const originalValue = cardValue.dataset.original;
                        const yenElement = yenConverted[index];
                        
                        if (currency === 'jpy') {
                            // Show JPY conversion
                            const numericValue = parseFloat(originalValue.replace(/[^0-9.-]/g, ''));
                            if (!isNaN(numericValue)) {
                                const yenValue = (numericValue * USDJPY_RATE).toLocaleString('ja-JP');
                                if (yenElement) {
                                    yenElement.textContent = `â‰ˆ Â¥${yenValue}`;
                                    yenElement.style.display = 'block';
                                }
                            }
                        } else {
                            // Hide JPY conversion
                            if (yenElement) {
                                yenElement.style.display = 'none';
                            }
                        }
                    });
                });
            });

            /* ---------- Market Card Modal System ---------- */
            const marketCards = document.querySelectorAll('.market-card');
            const modal = document.getElementById('marketModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBasicInfo = document.getElementById('modalBasicInfo');
            const modalClose = document.getElementById('modalClose');
            
            marketCards.forEach(card => {
                card.addEventListener('click', function() {
                    const indicator = this.dataset.indicator;
                    const current = this.dataset.current;
                    const change = this.dataset.change;
                    const changePercent = this.dataset.changePercent;
                    const chartIntradayImg = this.dataset.chartIntradayImg;
                    
                    // Get technical indicators
                    const rsi = this.dataset.rsi;
                    const rsiColor = this.dataset.rsiColor;
                    const maDivergence = this.dataset.maDivergence;
                    const maDivergenceColor = this.dataset.maDivergenceColor;
                    const volumeAnalysis = this.dataset.volumeAnalysis;
                    const volumeAnalysisColor = this.dataset.volumeAnalysisColor;
                    
                    // Update modal content
                    modalTitle.textContent = `${indicator} è©³ç´°æƒ…å ±`;
                    modalBasicInfo.innerHTML = `
                        <h3>åŸºæœ¬æƒ…å ±</h3>
                        <div class="info-row">
                            <span class="info-label">æŒ‡æ¨™å:</span>
                            <span class="info-value">${indicator}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç¾åœ¨å€¤:</span>
                            <span class="info-value">${current}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å‰æ—¥æ¯”:</span>
                            <span class="info-value ${change && change !== 'N/A' ? (parseFloat(change) > 0 ? 'positive' : parseFloat(change) < 0 ? 'negative' : '') : ''}">${change || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">å¤‰åŒ–ç‡:</span>
                            <span class="info-value ${changePercent && changePercent !== 'N/A' ? (parseFloat(changePercent.replace('%', '')) > 0 ? 'positive' : parseFloat(changePercent.replace('%', '')) < 0 ? 'negative' : '') : ''}">${changePercent || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ›´æ–°æ™‚é–“:</span>
                            <span class="info-value">${new Date().toLocaleString('ja-JP')}</span>
                        </div>
                        
                        <div class="technical-indicators">
                            <h3>ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™</h3>
                            <div class="technical-row">
                                <span class="technical-label">RSI (14æ—¥):</span>
                                <span class="technical-value" style="color: ${rsiColor || '#6c757d'}">${rsi || 'N/A'}</span>
                            </div>
                            <div class="technical-row">
                                <span class="technical-label">ç§»å‹•å¹³å‡ä¹–é›¢ç‡ (25æ—¥):</span>
                                <span class="technical-value" style="color: ${maDivergenceColor || '#6c757d'}">${maDivergence || 'N/A'}</span>
                            </div>
                            <div class="technical-row">
                                <span class="technical-label">å‡ºæ¥é«˜åˆ†æ (20æ—¥å¹³å‡æ¯”):</span>
                                <span class="technical-value" style="color: ${volumeAnalysisColor || '#6c757d'}">${volumeAnalysis || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                    
                    // Setup chart functionality
                    const modalChartFrame = document.getElementById('modalChartFrame');
                    const chartTabs = document.querySelectorAll('.chart-tab-btn');
                    const chartLoading = document.querySelector('.chart-loading');
                    
                    // Store chart URLs for tab switching
                    modalChartFrame.dataset.intradayImg = chartIntradayImg;
                    
                    // Enhanced chart loading with better feedback
                    if (chartIntradayImg) {
                        const chartLoadingIndicator = document.getElementById('chartLoadingIndicator');
                        const smallText = chartLoadingIndicator.querySelector('small');
                        
                        chartLoadingIndicator.style.display = 'flex';
                        modalChartFrame.style.display = 'none';
                        
                        // Loading message progression
                        setTimeout(() => {
                            smallText.textContent = 'ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...';
                        }, 800);
                        
                        setTimeout(() => {
                            smallText.textContent = 'æœ€æ–°ã®å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...';
                        }, 1600);
                        
                        modalChartFrame.src = chartIntradayImg;
                        
                        modalChartFrame.onload = function() {
                            chartLoadingIndicator.style.display = 'none';
                            modalChartFrame.style.display = 'block';
                            modalChartFrame.style.opacity = '0';
                            modalChartFrame.style.transform = 'scale(0.95)';
                            
                            // Smooth fade-in transition
                            setTimeout(() => {
                                modalChartFrame.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                                modalChartFrame.style.opacity = '1';
                                modalChartFrame.style.transform = 'scale(1)';
                            }, 50);
                        };
                        
                        // Error handling for failed chart loads
                        modalChartFrame.onerror = function() {
                            chartLoadingIndicator.innerHTML = `
                                <div style="color: #dc3545;">ğŸ“Š ãƒãƒ£ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
                                <small style="margin-top: 10px; opacity: 0.8;">ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãŠè©¦ã—ãã ã•ã„</small>
                            `;
                        };
                    }
                    
                    // Show modal
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                });
            });
            
            // Close modal functionality
            function closeModal() {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
            
            modalClose.addEventListener('click', closeModal);
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    closeModal();
                }
            });

            /* ---------- Enhanced Data Freshness Indicators ---------- */
            function updateDataFreshness() {
                const freshnessIndicators = document.querySelectorAll('.freshness-indicator');
                const lastUpdated = new Date();
                const now = new Date();
                const timeDiff = Math.abs(now - lastUpdated) / (1000 * 60); // difference in minutes
                
                freshnessIndicators.forEach(indicator => {
                    const pulseDot = indicator.querySelector('.pulse-dot');
                    const span = indicator.querySelector('span');
                    
                    if (timeDiff < 5) {
                        indicator.className = 'freshness-indicator freshness-fresh';
                        pulseDot.className = 'pulse-dot';
                        span.textContent = 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ';
                    } else if (timeDiff < 30) {
                        indicator.className = 'freshness-indicator freshness-stale';
                        pulseDot.className = 'pulse-dot stale';
                        span.textContent = 'æœ€æ–°';
                    } else {
                        indicator.className = 'freshness-indicator freshness-old';
                        pulseDot.className = 'pulse-dot old';
                        span.textContent = 'æ›´æ–°è¦';
                    }
                });
            }
            
            // Update freshness every minute
            updateDataFreshness();
            setInterval(updateDataFreshness, 60000);

            /* ---------- Enhanced Tooltip System ---------- */
            const tooltips = document.querySelectorAll('.tooltip');
            
            tooltips.forEach(tooltip => {
                const tooltipText = tooltip.querySelector('.tooltiptext');
                if (tooltipText) {
                    tooltip.addEventListener('mouseenter', function() {
                        tooltipText.style.visibility = 'visible';
                        tooltipText.style.opacity = '1';
                        tooltipText.style.transform = 'translateY(0)';
                    });
                    
                    tooltip.addEventListener('mouseleave', function() {
                        tooltipText.style.visibility = 'hidden';
                        tooltipText.style.opacity = '0';
                        tooltipText.style.transform = 'translateY(10px)';
                    });
                }
            });

            /* ---------- Card Animation Enhancement ---------- */
            function animateCards() {
                const cards = document.querySelectorAll('.market-card');
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.animation = `slideInUp 0.6s ease-out ${index * 0.1}s both`;
                    }, 100);
                });
            }
            
            animateCards();

            /* ---------- Value Counter Animation ---------- */
            function animateValues() {
                const values = document.querySelectorAll('.card-value');
                values.forEach(value => {
                    const finalValue = value.textContent;
                    const numericValue = parseFloat(finalValue.replace(/[^0-9.-]/g, ''));
                    
                    if (!isNaN(numericValue)) {
                        let current = 0;
                        const increment = numericValue / 50; // 50 steps
                        const timer = setInterval(() => {
                            current += increment;
                            if (current >= numericValue) {
                                current = numericValue;
                                clearInterval(timer);
                            }
                            
                            // Update display with proper formatting
                            if (finalValue.includes('%')) {
                                value.textContent = current.toFixed(2) + '%';
                            } else if (numericValue > 1000) {
                                value.textContent = current.toFixed(2);
                            } else {
                                value.textContent = current.toFixed(2);
                            }
                        }, 20);
                    }
                });
            }
            
            // Animate values after a short delay
            setTimeout(animateValues, 500);

            /* ---------- Enhanced Notification System ---------- */
            function showNotification(message, type = 'info', duration = 3000) {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notif => notif.remove());
                
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <span class="notification-icon">${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
                        <span class="notification-message">${message}</span>
                        <button class="notification-close">&times;</button>
                    </div>
                `;
                
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? 'linear-gradient(135deg, #28a745, #20c997)' : 
                                type === 'error' ? 'linear-gradient(135deg, #dc3545, #e74c3c)' : 
                                'linear-gradient(135deg, #007bff, #0056b3)'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    z-index: 2000;
                    min-width: 300px;
                    max-width: 500px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                    animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                `;
                
                // Add close functionality
                const closeBtn = notification.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => {
                    notification.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                });
                
                document.body.appendChild(notification);
                
                // Auto-remove after specified duration
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, duration);
            }

            // Add notification animations to CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
                
                @keyframes slideOutRight {
                    from {
                        opacity: 1;
                        transform: translateX(0);
                    }
                    to {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                }
                
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .notification-icon {
                    font-size: 1.2em;
                    font-weight: bold;
                }
                
                .notification-message {
                    flex: 1;
                    font-size: 0.9em;
                    line-height: 1.4;
                }
                
                .notification-close {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 1.4em;
                    cursor: pointer;
                    padding: 0;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: background-color 0.2s ease;
                }
                
                .notification-close:hover {
                    background-color: rgba(255,255,255,0.2);
                }
            `;
            document.head.appendChild(style);

            /* ---------- Existing Chart and News Functionality ---------- */
            const tabButtons = document.querySelectorAll('.tab-button');
            const chartSections = document.querySelectorAll('.chart-section');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabSection = this.closest('.chart-section');
                    const tabContents = tabSection.querySelectorAll('.tab-content');
                    const tabButtonsInSection = tabSection.querySelectorAll('.tab-button');

                    // Remove active class from all buttons in this section
                    tabButtonsInSection.forEach(btn => btn.classList.remove('active'));
                    // Add active class to the clicked button
                    this.classList.add('active');

                    // Hide all tab contents in this section
                    tabContents.forEach(content => content.classList.add('hidden'));

                    // Show the target tab content
                    const targetId = this.dataset.tabTarget;
                    const targetContent = tabSection.querySelector(`#${targetId}`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        // ç”»åƒã®srcã‚’æ›´æ–°ã—ã¦å†èª­ã¿è¾¼ã¿ã‚’å¼·åˆ¶
                        const imgElement = targetContent.querySelector('img');

                        if (imgElement) {
                            const originalDataSrc = targetContent.dataset.src.split('?')[0]; // data-srcã‹ã‚‰å…ƒã®ãƒ‘ã‚¹ã‚’å–å¾—
                            const cacheBuster = new Date().getTime();
                            const newSrc = `${originalDataSrc}?v=${cacheBuster}`;
                            imgElement.src = newSrc; // srcã‚’æ›´æ–°
                        }
                    }
                });
            });

            // åˆæœŸè¡¨ç¤ºæ™‚ã«å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€åˆã®ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            chartSections.forEach(section => {
                const firstButton = section.querySelector('.tab-button');
                if (firstButton) {
                    const targetId = firstButton.dataset.tabTarget;
                    const targetContent = section.querySelector(`#${targetId}`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        const imgElement = targetContent.querySelector('img');
                        if (imgElement) {
                            const originalDataSrc = targetContent.dataset.src.split('?')[0];
                            const cacheBuster = new Date().getTime();
                            imgElement.src = `${originalDataSrc}?v=${cacheBuster}`;
                        }
                    }
                }
            });

            /* ---------- News Table Sorting ---------- */
            const newsTable = document.querySelector('.news table');
            if (newsTable) {
                const headers = newsTable.querySelectorAll('th.sortable');
                headers.forEach((th, index) => {
                    th.addEventListener('click', () => {
                        const tbody = newsTable.querySelector('tbody');
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        const ascending = !(th.classList.contains('asc'));
                        headers.forEach(h => h.classList.remove('asc', 'desc'));
                        th.classList.add(ascending ? 'asc' : 'desc');
                        const type = th.dataset.type || 'string';
                        rows.sort((a, b) => {
                            const aText = a.children[index].textContent.trim();
                            const bText = b.children[index].textContent.trim();
                            if (type === 'date') {
                                return ascending ? (new Date(aText) - new Date(bText)) : (new Date(bText) - new Date(aText));
                            }
                            return ascending ? aText.localeCompare(bText) : bText.localeCompare(aText);
                        });
                        tbody.append(...rows);
                    });
                });
            }

            /* ---------- Enhanced News Filtering ---------- */
            if (newsTable) {
                const countryFilter = document.getElementById('countryFilter');
                const keywordFilter = document.getElementById('keywordFilter');
                const clearFiltersBtn = document.getElementById('clearFilters');
                const tbody = newsTable.querySelector('tbody');
                const visibleCountSpan = document.getElementById('visibleCount');
                const totalCountSpan = document.getElementById('totalCount');
                const allRows = Array.from(tbody.querySelectorAll('tr'));
                
                // Populate country filter options
                const countrySet = new Set();
                allRows.forEach(tr => {
                    const code = tr.children[1].textContent.trim();
                    countrySet.add(code);
                });
                [...countrySet].sort().forEach(code => {
                    const opt = document.createElement('option');
                    opt.value = code; 
                    opt.textContent = code;
                    countryFilter.appendChild(opt);
                });
                
                // Filter function
                function applyFilters() {
                    const selectedCountry = countryFilter.value;
                    const keyword = keywordFilter.value.toLowerCase().trim();
                    let visibleCount = 0;
                    
                    allRows.forEach(tr => {
                        const country = tr.dataset.country;
                        const title = tr.dataset.title;
                        
                        const countryMatch = selectedCountry === 'ALL' || country === selectedCountry;
                        const keywordMatch = !keyword || title.includes(keyword);
                        
                        const shouldShow = countryMatch && keywordMatch;
                        tr.style.display = shouldShow ? '' : 'none';
                        
                        if (shouldShow) visibleCount++;
                    });
                    
                    visibleCountSpan.textContent = visibleCount;
                }
                
                // Event listeners
                countryFilter.addEventListener('change', applyFilters);
                keywordFilter.addEventListener('input', debounce(applyFilters, 300));
                
                clearFiltersBtn.addEventListener('click', () => {
                    countryFilter.value = 'ALL';
                    keywordFilter.value = '';
                    applyFilters();
                });
                
                // Debounce function for keyword search
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
            }

            /* ---------- Chart Customization Controls ---------- */
            const updateChartsBtn = document.getElementById('updateCharts');
            const resetChartsBtn = document.getElementById('resetCharts');
            const maTypeSelect = document.getElementById('maType');
            const maCheckboxes = document.querySelectorAll('.ma-checkboxes input[type="checkbox"]');
            
            if (updateChartsBtn && resetChartsBtn) {
                // Update charts button
                updateChartsBtn.addEventListener('click', async () => {
                    const selectedMaType = maTypeSelect.value;
                    const selectedMAs = Array.from(maCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);
                    
                    updateChartsBtn.disabled = true;
                    updateChartsBtn.textContent = 'æ›´æ–°ä¸­...';
                    
                    // Display current settings
                    const settingsInfo = `ç§»å‹•å¹³å‡è¨­å®š: ${selectedMaType} - ${selectedMAs.map(ma => {
                        switch(ma) {
                            case 'short': return '25æ—¥ç·š';
                            case 'medium': return '50æ—¥ç·š';
                            case 'long': return '75æ—¥ç·š';
                            default: return ma;
                        }
                    }).join(', ')}`;
                    
                    try {
                        // Send chart update request to server
                        const response = await fetch('/update-charts', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                ma_type: selectedMaType,
                                selected_mas: selectedMAs
                            })
                        });
                        
                        if (response.ok) {
                            showNotification('ãƒãƒ£ãƒ¼ãƒˆãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚', 'success');
                            
                            // Optional: Auto-reload the page after a delay
                            setTimeout(() => {
                                if (confirm('æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ')) {
                                    window.location.reload();
                                }
                            }, 2000);
                        } else {
                            throw new Error('ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } catch (error) {
                        console.error('Chart update error:', error);
                        showNotification('ãƒãƒ£ãƒ¼ãƒˆè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚å®Ÿéš›ã®æ›´æ–°ã«ã¯æ‰‹å‹•ã§ã®ãƒãƒ£ãƒ¼ãƒˆå†ç”ŸæˆãŒå¿…è¦ã§ã™ã€‚', 'info');
                    }
                    
                    setTimeout(() => {
                        updateChartsBtn.disabled = false;
                        updateChartsBtn.textContent = 'ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°';
                    }, 1000);
                });
                
                // Reset charts button
                resetChartsBtn.addEventListener('click', () => {
                    maTypeSelect.value = 'SMA';
                    maCheckboxes.forEach(cb => {
                        cb.checked = cb.value === 'short' || cb.value === 'long';
                    });
                    showNotification('ãƒãƒ£ãƒ¼ãƒˆè¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'success');
                });
            }

            /* ---------- Welcome Message ---------- */
            setTimeout(() => {
                showNotification('ç±³å›½ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ¬ãƒãƒ¼ãƒˆã¸ã‚ˆã†ã“ãï¼ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°æƒ…å ±ã‚’ã”è¦§ãã ã•ã„ã€‚', 'info', 5000);
            }, 1000);

        });
    </script>
</body>
</html>
